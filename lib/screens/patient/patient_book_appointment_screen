import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import '../../services/api_service.dart';
import '../../widgets/custom_button.dart';
import '../../widgets/custom_textfield.dart';

class BookAppointmentScreen extends StatefulWidget {
  final dynamic doctor;
  const BookAppointmentScreen({super.key, required this.doctor});

  @override
  State<BookAppointmentScreen> createState() => _BookAppointmentScreenState();
}

class _BookAppointmentScreenState extends State<BookAppointmentScreen> {
  DateTime? selectedDate;
  TimeOfDay? selectedTime;
  bool _loading = false;

  // ✅ اسم الدكتور من أكثر من احتمال (fullName أو name)
  String get _doctorName {
    return widget.doctor['fullName'] ??
        widget.doctor['name'] ??
        widget.doctor['doctorName'] ??
        'Doctor';
  }

  // ✅ ID الدكتور مع حماية للأنواع
  dynamic get _doctorIdRaw => widget.doctor['id'] ?? widget.doctor['doctorId'];

  Future<void> pickDate() async {
    final now = DateTime.now();
    final date = await showDatePicker(
      context: context,
      initialDate: now,
      firstDate: now,
      lastDate: now.add(const Duration(days: 365)),
    );
    if (date != null) {
      setState(() => selectedDate = date);
    }
  }

  Future<void> pickTime() async {
    final time =
        await showTimePicker(context: context, initialTime: TimeOfDay.now());
    if (time != null) {
      setState(() => selectedTime = time);
    }
  }

  Future<void> bookAppointment() async {
    if (selectedDate == null || selectedTime == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("الرجاء اختيار التاريخ والوقت أولاً")),
      );
      return;
    }

    if (_doctorIdRaw == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("حدث خطأ في بيانات الطبيب")),
      );
      return;
    }

    setState(() => _loading = true);

    final start = DateTime(
      selectedDate!.year,
      selectedDate!.month,
      selectedDate!.day,
      selectedTime!.hour,
      selectedTime!.minute,
    );
    // ⏱ مدة الموعد 30 دقيقة كما في الكود الأصلي
    final end = start.add(const Duration(minutes: 30));

    final success = await ApiService.bookAppointment(
      doctorId: _doctorIdRaw,
      startsAt: start,
      endsAt: end,
    );

    setState(() => _loading = false);

    if (success) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text("تم حجز الموعد بنجاح مع $_doctorName ✅"),
        ),
      );
      Navigator.pop(context, true); // نرجع بنتيجة نجاح (اختياري)
    } else {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("فشل في حجز الموعد، حاول مرة أخرى")),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final dateText = selectedDate == null
        ? "اختر التاريخ"
        : DateFormat('y/MM/dd').format(selectedDate!);

    final timeText =
        selectedTime == null ? "اختر الوقت" : selectedTime!.format(context);

    return Scaffold(
      appBar: AppBar(
        title: Text("حجز موعد مع $_doctorName"),
      ),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            CustomButton(
              text: dateText,
              onPressed: _loading ? null : pickDate,
            ),
            const SizedBox(height: 16),
            CustomButton(
              text: timeText,
              onPressed: _loading ? null : pickTime,
            ),
            const SizedBox(height: 32),
            CustomButton(
              text: "تأكيد الحجز",
              onPressed: _loading ? null : bookAppointment,
              isLoading: _loading,
            ),
          ],
        ),
      ),
    );
  }
}
